// --- 替换你原来的 syncToCloud 和 loadFromCloud 函数 ---
const GIST_PROXY = 'https://api.codetabs.com/v1/proxy?quest=';

async function syncToCloud() {
  if (!config.token || !config.id) return;
  document.getElementById('cloudStatus').innerText = '正在备份...';
  try {
    const url = `https://api.github.com/gists/${config.id}`;
    const body = { files: { "funds.json": { content: JSON.stringify(fundList) } } };
    
    // 优先直连，失败走代理
    let res;
    try {
      res = await fetch(url, {
        method: 'PATCH',
        headers: { 
          'Authorization': `token ${config.token}`, 
          'Content-Type': 'application/json' 
        },
        body: JSON.stringify(body)
      });
    } catch(e) {
      res = await fetch(GIST_PROXY + encodeURIComponent(url), {
        method: 'POST',
        headers: { 
          'Authorization': `token ${config.token}`, 
          'Content-Type': 'application/json' 
        },
        body: JSON.stringify(body)
      });
    }

    if (res.ok) {
      document.getElementById('cloudStatus').innerText = '云端数据已同步';
      showToast('备份成功');
    } else {
      document.getElementById('cloudStatus').innerText = '同步失败';
    }
  } catch (e) {
    document.getElementById('cloudStatus').innerText = '网络异常';
    console.error('Sync error:', e);
  }
}

async function loadFromCloud() {
  if (!config.token || !config.id) {
    document.getElementById('cloudStatus').innerText = '未配置云端';
    return;
  }
  
  document.getElementById('cloudStatus').innerText = '正在拉取...';
  
  try {
    const url = `https://api.github.com/gists/${config.id}`;
    let res;
    try {
      res = await fetch(url, {
        headers: { 'Authorization': `token ${config.token}` }
      });
    } catch(e) {
      res = await fetch(GIST_PROXY + encodeURIComponent(url), {
        headers: { 'Authorization': `token ${config.token}` }
      });
    }

    if (!res.ok) throw new Error('gist请求失败');
    
    const data = await res.json();
    const cloudData = JSON.parse(data.files["funds.json"].content);
    
    if (Array.isArray(cloudData)) {
      fundList = cloudData;
      localStorage.setItem('fundList_final', JSON.stringify(fundList));
      render();
      refreshAllFunds();
      document.getElementById('cloudStatus').innerText = '同步成功，已是最新';
      showToast('云端数据已恢复');
    }
  } catch (e) { 
    document.getElementById('cloudStatus').innerText = '拉取失败，请检查配置';
    showToast('拉取失败');
    console.error('Load error:', e);
  }
}
