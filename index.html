<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>基金实时估值 - 寒松个人版</title>
<style>
/* 样式部分保持不变 */
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; background-color: #f5f7fa; min-height: 100vh; overflow-x: hidden; }
#toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 12px 24px; border-radius: 10px; font-size: 14px; z-index: 100000; display: none; text-align: center; }
#lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f7fa; z-index: 999999; display: flex; align-items: center; justify-content: center; }
.lock-box { background: #fff; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 85%; max-width: 300px; text-align: center; }
.lock-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; font-size: 16px; text-align: center; outline: none; }
.lock-btn { width: 100%; padding: 12px; background: #007aff; color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; }
.sync-bar { background: #fff; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; font-size: 12px; position: sticky; top: 0; z-index: 100; }
.main-wrapper { display: grid; grid-template-columns: 100%; justify-items: center; gap: 16px; width: 100%; padding: 16px 0; visibility: hidden; }
.content-block { width: calc(100% - 32px); max-width: 500px; }
.summary-card { background: linear-gradient(135deg,#4facfe 0%,#007aff 100%); border-radius: 20px; padding: 20px; color: #fff; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; }
.summary-item .value { font-size: 20px; font-weight: 700; }
.fund-item { background-color: #fff; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.red { color: #ff3b30; } .green { color: #34c759; }
/* ... [其他样式逻辑同前] ... */
</style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <div class="lock-title" style="font-weight:bold;margin-bottom:15px;">系统安全校验</div>
        <input type="password" id="lockInput" class="lock-input" placeholder="请输入当前密码">
        <button class="lock-btn" onclick="checkLock()">确认进入</button>
    </div>
</div>

<div id="toast"></div>

<div id="pull-container">
  <div class="sync-bar">
      <span id="cloudStatus">等待校验...</span>
      <button class="config-btn" onclick="openConfig()" style="color:#007aff;background:none;border:none;">云端配置</button>
  </div>
  <div class="main-wrapper" id="mainApp">
    <div class="content-block"><h2 style="text-align:center;">基金实时估值-寒松个人版</h2></div>
    <div class="content-block">
      <div class="summary-card">
        <div class="summary-item"><span>估算市值</span><div id="totalMarketValue">0.00</div></div>
        <div class="summary-item"><span>累计投入</span><div id="totalMoney">0.00</div></div>
        <div class="summary-item"><span>持仓盈亏</span><div id="totalHoldingProfit">+0.00</div></div>
        <div class="summary-item"><span>今日盈亏</span><div id="totalTodayProfit">+0.00</div></div>
      </div>
    </div>
    <div class="content-block" style="display:flex;gap:10px;margin-top:10px;">
        <input id="fundCode" type="text" placeholder="代码" style="flex:1;padding:12px;border-radius:10px;border:1px solid #ddd;">
        <input id="holdAmount" type="text" placeholder="金额" style="flex:1;padding:12px;border-radius:10px;border:1px solid #ddd;">
        <button onclick="addFund()" style="padding:0 20px;background:#007aff;color:#fff;border:none;border-radius:10px;">添加</button>
    </div>
    <div id="fundList" class="content-block"></div>
  </div>
</div>

<script>
// ===================== APK 核心控制区 =====================
const PAGE_PASSWORD = 'lhs888'; // 修改密码
const FORCE_FINGERPRINT = '20260223_V3.5'; // <--- 关键！改密码时务必改这个版本号
// =========================================================

// 1. 暴力去缓存逻辑（针对 APK WebView）
(function() {
    const localFingerprint = localStorage.getItem('hs_fingerprint');
    // 如果指纹不对，立刻抹除本地所有登录凭证
    if (localFingerprint !== FORCE_FINGERPRINT) {
        localStorage.removeItem('hs_access_token');
        localStorage.removeItem('hs_fingerprint');
        // 增加 URL 随机参数强制浏览器重新拉取最新源码
        if (!window.location.search.includes('v=')) {
            window.location.href = window.location.protocol + '//' + window.location.host + window.location.pathname + '?v=' + Date.now();
        }
    }
})();

let fundList = JSON.parse(localStorage.getItem('fundList_final') || '[]');
let config = JSON.parse(localStorage.getItem('gist_config_hansong') || '{"token":"","id":""}');

// 2. 强校验启动器
function startSafetyCheck() {
    const isAuth = localStorage.getItem('hs_access_token');
    const lockEl = document.getElementById('lock-screen');
    const appEl = document.getElementById('mainApp');

    if (isAuth === PAGE_PASSWORD) {
        lockEl.style.display = 'none';
        appEl.style.visibility = 'visible';
        initApp();
    } else {
        lockEl.style.display = 'flex';
        appEl.style.visibility = 'hidden';
    }
}

function checkLock() {
    const val = document.getElementById('lockInput').value;
    if (val === PAGE_PASSWORD) {
        localStorage.setItem('hs_access_token', PAGE_PASSWORD);
        localStorage.setItem('hs_fingerprint', FORCE_FINGERPRINT);
        showToast('验证通过');
        setTimeout(() => location.reload(), 300); // 刷新以应用指纹
    } else {
        showToast('密码错误');
    }
}

function initApp() {
    render();
    if (config.token && config.id) { loadFromCloud(); } else { refreshAllFunds(); }
    setInterval(refreshAllFunds, 60000);
}

// 页面加载瞬间执行
startSafetyCheck();

// --- 以下为原有业务逻辑（添加、删除、渲染、同步等） ---
function showToast(t){const o=document.getElementById("toast");o.innerText=t;o.style.display="block";setTimeout(()=>o.style.display="none",2000)}
function render(){
    const listEl = document.getElementById('fundList'); listEl.innerHTML = '';
    let totalMoney = 0; let totalTodayProfit = 0;
    fundList.forEach((item, index) => {
        totalMoney += parseFloat(item.money) || 0;
        const itemEl = document.createElement('div'); itemEl.className = 'fund-item';
        itemEl.innerHTML = `<div><b>${item.name || '加载中...'}</b> (${item.code})</div><div style="font-size:13px;margin-top:8px;">${item.info || '采集数据中...'}</div><button onclick="deleteFund(${index})" style="margin-top:10px;padding:4px 8px;font-size:12px;background:#fb6e52;color:#fff;border:none;border-radius:4px;">删除</button>`;
        listEl.appendChild(itemEl);
    });
    document.getElementById('totalMoney').textContent = totalMoney.toFixed(2);
}
async function refreshAllFunds(){/* 此处省略 fetch 逻辑，建议保留你原有的完整 fetch 块 */}
async function loadFromCloud(){/* 此处省略拉取逻辑 */}
function addFund(){/* 此处省略添加逻辑 */}
function deleteFund(i){fundList.splice(i,1);localStorage.setItem('fundList_final',JSON.stringify(fundList));render();showToast('已删除')}
function openConfig(){/* 此处省略配置弹窗逻辑 */}
</script>
</body>
</html>
