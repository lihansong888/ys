<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>基金实时估值 - 寒松个人版</title>
<style>
/* 这里完全保留你原来的所有 CSS 样式，不做任何修改 */
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; background-color: #f5f7fa; padding: 0; min-height: 100vh; overflow-x: hidden; }
#toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 12px 24px; border-radius: 10px; font-size: 14px; z-index: 100000; display: none; pointer-events: none; text-align: center; min-width: 120px; }
#lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f7fa; z-index: 999999; display: none; align-items: center; justify-content: center; }
.lock-box { background: #fff; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 85%; max-width: 300px; text-align: center; }
.lock-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #333; }
.lock-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; font-size: 16px; text-align: center; outline: none; }
.lock-btn { width: 100%; padding: 12px; background: #007aff; color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; }
.sync-bar { background: #fff; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; font-size: 12px; position: sticky; top: 0; z-index: 100; }
#cloudStatus { color: #888; font-weight: 500; }
.config-btn { color: #007aff; border: none; background: none; font-size: 13px; font-weight: 600; cursor: pointer; padding: 4px 8px; }
#pull-container { position: relative; transition: transform 0.3s ease; }
#pull-loader { position: absolute; top: -50px; left: 0; width: 100%; height: 50px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px; font-weight: 500; }
.main-wrapper { display: grid; grid-template-columns: 100%; justify-items: center; gap: 16px; width: 100%; padding: 16px 0; }
.content-block { width: calc(100% - 32px); max-width: 500px; }
h2 { text-align: center; color: #222; font-size: 20px; margin-bottom: 4px; }
.summary-card { background: linear-gradient(135deg,#4facfe 0%,#007aff 100%); border-radius: 20px; padding: 20px; color: #fff; box-shadow: 0 10px 20px rgba(0,122,255,0.15); display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; }
.summary-item .label { font-size: 13px; opacity: 0.9; margin-bottom: 6px; display: block; }
.summary-item .value { font-size: 20px; font-weight: 700; font-family: "DIN Alternate",sans-serif; }
.profit-value { color: #ffda00; }
.add-section { display: grid; grid-template-columns: 1fr 1fr 60px; gap: 10px; width: 100%; }
.add-section input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 14px; background: #fff; outline: none; }
.add-section button { background-color: #3b82f6; color: #fff; border: none; border-radius: 12px; font-size: 13px; font-weight: 500; }
.fund-item { background-color: #fff; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.item-header { display: grid; grid-template-columns: 1fr auto; align-items: center; margin-bottom: 12px; }
.fund-name { font-weight: 600; color: #222; font-size: 15px; line-height: 1.4; display: block; }
.fund-code { color: #999; font-size: 12px; }
.btn-group { display: flex; gap: 8px; }
.action-btn { width: 42px; height: 42px; border: none; border-radius: 8px; color: #fff; font-size: 12px; font-weight: 500; }
.edit-btn { background-color: #5d9cec; }
.delete-btn { background-color: #fb6e52; }
.item-info { line-height: 1.8; font-size: 13px; border-top: 1px solid #f8f8f8; padding-top: 10px; color: #444; }
.data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.data-label { color: #888; font-size: 12px; }
.analysis-tag { display: inline-block; padding: 8px 10px; border-radius: 8px; font-size: 12px; margin: 8px 0; font-weight: bold; width: 100%; line-height: 1.6; }
.time-label { font-size: 11px; color: #666; text-align: right; margin-top: 4px; font-weight: 500; }
.red { color: #ff3b30; }
.green { color: #34c759; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.modal { background: #fff; border-radius: 16px; width: 85%; max-width: 320px; padding: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
.modal-title { font-size: 17px; font-weight: 700; margin-bottom: 18px; text-align: center; color: #222; }
.modal-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; font-size: 14px; outline: none; }
.modal-buttons { display: flex; gap: 12px; }
.modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 14px; font-weight: 600; }
.modal-btn-cancel { background: #f0f0f0; color: #666; }
.modal-btn-confirm { background: #007aff; color: #fff; }
</style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <div class="lock-title">身份验证</div>
        <input type="password" id="lockInput" class="lock-input" placeholder="请输入密码">
        <button class="lock-btn" onclick="checkLock()">确认进入</button>
    </div>
</div>

<div id="toast"></div>

<div class="sync-bar">
    <span id="cloudStatus">未连接 GitHub 云端</span>
    <button class="config-btn" onclick="openConfig()">云端配置</button>
</div>

<div id="pull-container">
  <div id="pull-loader">下拉刷新...</div>
  <div class="main-wrapper" id="mainWrapper" style="display:none;">
    <div class="content-block"><h2>基金实时估值-寒松个人版</h2></div>
    <div class="content-block">
      <div class="summary-card">
        <div class="summary-item"><span class="label">估算总市值</span><span class="value" id="totalMarketValue">0.00</span></div>
        <div class="summary-item"><span class="label">累计总投入</span><span class="value" id="totalMoney">0.00</span></div>
        <div class="summary-item"><span class="label">持仓盈亏</span><span class="value profit-value" id="totalHoldingProfit">+0.00</span></div>
        <div class="summary-item"><span class="label">今日盈亏</span><span class="value profit-value" id="totalTodayProfit">+0.00</span></div>
      </div>
    </div>
    <div class="content-block">
      <div class="add-section">
        <input id="fundCode" type="text" inputmode="numeric" placeholder="代码">
        <input id="holdAmount" type="text" inputmode="decimal" placeholder="金额">
        <button onclick="addFund()">添加</button>
      </div>
    </div>
    <div class="content-block"><div id="fundList"></div></div>
  </div>
</div>

<script>
// ===================== 密码 & 版本指纹（APK 失效核心） =====================
const PAGE_PASSWORD = '888'; 
const AUTH_VERSION = '20260223_V1'; // <--- 重点：改密码时，必须同时修改这个版本号
// =========================================================================

// APK 强制刷新逻辑：对比版本指纹，不一致则暴力清空
(function() {
    const localVer = localStorage.getItem('hansong_auth_ver');
    if (localVer !== AUTH_VERSION) {
        localStorage.removeItem('hansong_auth_pwd');
        localStorage.removeItem('hansong_auth_ver');
    }
})();

let fundList = JSON.parse(localStorage.getItem('fundList_final') || '[]');
let config = JSON.parse(localStorage.getItem('gist_config_hansong') || '{"token":"","id":""}');
let isRefreshing = false;

// 验证函数
function applyLock() {
  const lastVerifiedPwd = localStorage.getItem('hansong_auth_pwd');
  const lockEl = document.getElementById('lock-screen');
  const mainEl = document.getElementById('mainWrapper');
  
  if (lastVerifiedPwd !== PAGE_PASSWORD) {
    lockEl.style.display = 'flex';
    mainEl.style.display = 'none';
  } else {
    lockEl.style.display = 'none';
    mainEl.style.display = 'grid';
    initApp();
  }
}

function checkLock() {
  const input = document.getElementById('lockInput').value;
  if (input === PAGE_PASSWORD) {
    localStorage.setItem('hansong_auth_pwd', PAGE_PASSWORD);
    localStorage.setItem('hansong_auth_ver', AUTH_VERSION); // 存入指纹
    showToast('登录成功');
    setTimeout(() => { location.reload(); }, 500);
  } else {
    showToast('密码错误');
  }
}

function initApp() {
  render();
  if (config.token && config.id) { loadFromCloud(); } else { refreshAllFunds(); }
  setInterval(refreshAllFunds, 60000);
}

// 立即执行锁定检查
applyLock();

// --- 以下是你原来的所有业务逻辑，完全没有改动布局 ---

function showToast(text) {
  const toast = document.getElementById('toast');
  toast.innerText = text; toast.style.display = 'block';
  if (window.toastTimer) clearTimeout(window.toastTimer);
  window.toastTimer = setTimeout(() => { toast.style.display = 'none'; }, 2000);
}

async function syncToCloud() {
  if (!config.token || !config.id) return;
  document.getElementById('cloudStatus').innerText = '正在备份...';
  try {
    const res = await fetch(`https://api.github.com/gists/${config.id}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ files: { "funds.json": { content: JSON.stringify(fundList) } } })
    });
    if (res.ok) { document.getElementById('cloudStatus').innerText = '云端数据已同步'; }
    else { document.getElementById('cloudStatus').innerText = '同步异常'; }
  } catch (e) { document.getElementById('cloudStatus').innerText = '网络连接失败'; }
}

async function loadFromCloud() {
  if (!config.token || !config.id) return;
  document.getElementById('cloudStatus').innerText = '正在拉取云端...';
  try {
    const res = await fetch(`https://api.github.com/gists/${config.id}`, {
      headers: { 'Authorization': `token ${config.token}` }
    });
    if (!res.ok) throw new Error();
    const data = await res.json();
    const cloudData = JSON.parse(data.files["funds.json"].content);
    if (Array.isArray(cloudData)) {
      fundList = cloudData;
      localStorage.setItem('fundList_final', JSON.stringify(fundList));
      render();
      refreshAllFunds();
      document.getElementById('cloudStatus').innerText = '同步成功，已是最新';
    }
  } catch (e) { 
    document.getElementById('cloudStatus').innerText = '拉取失败，请检查配置';
    showToast('云端拉取失败');
  }
}

function getAdvice(d, money) {
  const gszzl = parseFloat(d.gszzl || 0);
  const now = new Date();
  const isActionTime = now.getHours() === 14 && now.getMinutes() >= 30;
  const name = d.name || "";
  const code = d.code || "";
  const codeMap = { "004927": "低空经济", "015790": "商业航天", "002580": "半导体", "020398": "创新药", "018994": "CPO" };
  let industry, extraTip;
  if (codeMap[code]) { industry = codeMap[code]; } 
  else if (name.includes("半导体") || name.includes("芯片")) { industry = "半导体"; } 
  else if (name.includes("创新药") || name.includes("医药")) { industry = "创新药"; } 
  else if (name.includes("CPO") || name.includes("光模块")) { industry = "CPO"; } 
  else if (name.includes("纳斯达克")) { industry = "纳斯达克"; } 
  else { industry = "主题基金"; }
  let advice = "", cls = "red";
  extraTip = "波段操作，严格止损";
  if (gszzl >= 3) { advice = isActionTime ? "减仓止盈" : "不追高"; cls = "red"; } 
  else if (gszzl <= -3) { advice = isActionTime ? "控仓止损" : "不抄底"; cls = "red"; } 
  else if (gszzl > 0) { advice = "持有观望"; cls = "red"; } 
  else { advice = "弱势不补"; cls = "green"; }
  return { industry, advice, adviceClass: cls, status: gszzl >= 0 ? "上涨" : "下跌", extraTip };
}

function render() {
  const listEl = document.getElementById('fundList'); listEl.innerHTML = '';
  let totalMoney = 0; let totalTodayProfit = 0;
  fundList.forEach((item, index) => {
    totalMoney += parseFloat(item.money) || 0;
    const itemEl = document.createElement('div'); itemEl.className = 'fund-item';
    itemEl.innerHTML = `<div class="item-header"><div><span class="fund-name">${item.name || '加载中...'}</span><span class="fund-code">${item.code}</span></div><div class="btn-group"><button class="action-btn edit-btn" onclick="editFund(${index})">编辑</button><button class="action-btn delete-btn" onclick="deleteFund(${index})">删除</button></div></div><div class="item-info">${item.info || '采集数据中...'}</div>`;
    listEl.appendChild(itemEl);
    if (item.info) {
      const profitMatch = item.info.match(/今日盈亏：<span class="[^"]+">([\d.-]+) 元/);
      if (profitMatch) totalTodayProfit += parseFloat(profitMatch[1]) || 0;
    }
  });
  document.getElementById('totalMoney').textContent = totalMoney.toFixed(2);
  document.getElementById('totalTodayProfit').textContent = (totalTodayProfit >= 0 ? '+' : '') + totalTodayProfit.toFixed(2);
  document.getElementById('totalMarketValue').textContent = (totalMoney + totalTodayProfit).toFixed(2);
  document.getElementById('totalHoldingProfit').textContent = (totalTodayProfit >= 0 ? '+' : '') + totalTodayProfit.toFixed(2);
  document.querySelectorAll('.profit-value').forEach(el => {
    const val = parseFloat(el.textContent); el.style.color = val >= 0 ? '#ffda00' : '#28ff7b'; 
  });
}

function fetchFundData(code, money, index) {
  return new Promise(resolve => {
    window.jsonpgz = function(d) {
      try {
        if (!d || !d.name) {
          fundList[index].info = `<div class="analysis-tag" style="background:#f5f5f5;color:#666">海外基金无实时估值</div>`;
          fundList[index].name = fundList[index].name || code;
          render(); return;
        }
        const gszzl = parseFloat(d.gszzl || 0); const dwjz = d.dwjz || '0'; const gsz = d.gsz || '0';
        const profit = (money * gszzl / 100).toFixed(2); const colorClass = gszzl >= 0 ? 'red' : 'green';
        const diff = (parseFloat(gsz) - parseFloat(dwjz)).toFixed(4);
        const { industry, advice, adviceClass, status, extraTip } = getAdvice(d, money);
        const info = `<div class="data-grid"><div>昨收: ${dwjz}</div><div>估算: <span class="${colorClass}">${gsz}</span></div><div>涨跌: <span class="${colorClass}">${gszzl.toFixed(2)}%</span></div></div><div style="margin-top:4px">持有：<b>${money} 元</b> | 盈亏：<span class="${colorClass}">${profit} 元</span></div><div class="analysis-tag" style="background:${adviceClass === 'red' ? '#fff0f0' : '#f0fff4'}; color:${adviceClass === 'red' ? '#ff3b30' : '#34c759'}">【${industry}】${advice}</div>`;
        fundList[index].name = d.name; fundList[index].info = info;
        localStorage.setItem('fundList_final', JSON.stringify(fundList)); render();
      } catch (e) {} finally { delete window.jsonpgz; resolve(); }
    }
    const script = document.createElement('script'); script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`; document.body.appendChild(script);
  });
}

async function refreshAllFunds() {
  if (isRefreshing) return; isRefreshing = true;
  for (let i = 0; i < fundList.length; i++) { await fetchFundData(fundList[i].code, fundList[i].money, i); }
  isRefreshing = false;
}

async function addFund() {
  const c = document.getElementById('fundCode').value.trim();
  const m = document.getElementById('holdAmount').value.trim();
  if (!c || !m) return;
  fundList.push({ code: c, money: m });
  localStorage.setItem('fundList_final', JSON.stringify(fundList));
  render(); refreshAllFunds(); syncToCloud();
}

function deleteFund(index) {
  fundList.splice(index, 1);
  localStorage.setItem('fundList_final', JSON.stringify(fundList));
  render(); syncToCloud();
}

function openConfig() {
  const t = prompt("GitHub Token", config.token);
  const i = prompt("Gist ID", config.id);
  if(t && i) {
    config.token = t; config.id = i;
    localStorage.setItem('gist_config_hansong', JSON.stringify(config));
    loadFromCloud();
  }
}
</script>
</body>
</html>
