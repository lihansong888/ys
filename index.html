<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>基金实时估值-寒松个人网页版</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      background: #f5f7fa;
      padding: 20px;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    .title {
      text-align: center;
      margin-bottom: 20px;
      font-size: 22px;
      color: #333;
    }
    .input-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .input-bar input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    .input-bar button {
      padding: 10px 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
    }
    .fund-item {
      background: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .fund-item .name {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .fund-item .info {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }
    .fund-item .btns {
      display: flex;
      gap: 8px;
    }
    .fund-item button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
    }
    .btn-edit {
      background: #28a745;
      color: white;
    }
    .btn-del {
      background: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">基金实时估值</div>
    <div class="input-bar">
      <input type="text" id="code" placeholder="基金代码">
      <input type="text" id="amount" placeholder="持有金额">
      <button onclick="addFund()">添加</button>
    </div>
    <div id="fund-list"></div>
  </div>

  <script>
    // ====================== 只修复这里：本地存储 ======================
    let fundList = JSON.parse(localStorage.getItem('fundList')) || [];

    function saveToLocal() {
      localStorage.setItem('fundList', JSON.stringify(fundList));
    }
    // ==================================================================

    // 渲染（原逻辑不变）
    function renderList() {
      const el = document.getElementById('fund-list');
      el.innerHTML = '';
      fundList.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'fund-item';
        div.innerHTML = `
          <div class="name">${item.name || item.code}</div>
          <div class="info">持有：${item.amount} 元</div>
          <div class="btns">
            <button class="btn-edit" onclick="edit(${index})">编辑金额</button>
            <button class="btn-del" onclick="del(${index})">删除</button>
          </div>
        `;
        el.appendChild(div);
      });
    }

    // 添加（原逻辑不变 + 只加 save）
    function addFund() {
      const code = document.getElementById('code').value.trim();
      const amount = document.getElementById('amount').value.trim();
      if (!code || !amount) return;
      fundList.push({
        code: code,
        amount: amount,
        name: '基金 ' + code
      });
      saveToLocal(); // 保存
      renderList();
      document.getElementById('code').value = '';
      document.getElementById('amount').value = '';
    }

    // 编辑（原逻辑不变 + 只加 save）
    function edit(index) {
      const newAmount = prompt('新的持有金额', fundList[index].amount);
      if (newAmount === null || newAmount === '') return;
      fundList[index].amount = newAmount;
      saveToLocal(); // 保存
      renderList();
    }

    // 删除（原逻辑不变 + 只加 save）
    function del(index) {
      if (!confirm('确定删除？')) return;
      fundList.splice(index, 1);
      saveToLocal(); // 保存
      renderList();
    }

    // 页面加载就渲染
    window.onload = renderList;
  </script>
</body>
</html>
  justify-content: center;
  line-height: 1.2;
}

.delete-btn {
  background-color: #ff3b30;
  color: #fff;
  border: none;
  width: 68px;
  height: 68px;
  border-radius: 8px;
  font-size: 18px;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1.2;
}

.item-info {
  line-height: 1.6;
  font-size: 15px;
}

/* 自定义弹窗样式 */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal {
  background-color: #fff;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.modal-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  text-align: center;
}

.modal-input {
  width: 100%;
  padding: 12px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  margin-bottom: 20px;
}

.modal-buttons {
  display: flex;
  gap: 12px;
}

.modal-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
}

.modal-btn-cancel {
  background-color: #f2f2f7;
  color: #000;
}

.modal-btn-confirm {
  background-color: #007aff;
  color: #fff;
}

.modal-btn-confirm-delete {
  background-color: #ff3b30;
  color: #fff;
}
</style>
</head>
<body>
<h2>基金实时估值</h2>

<div class="summary" id="summary">
  <div>
    <span class="label">总持有：</span>
    <span class="value" id="totalMoney">0 元</span>
  </div>
  <div>
    <span class="label">总盈亏：</span>
    <span class="value" id="totalProfit">0 元</span>
  </div>
</div>

<div class="add-section">
  <input id="fundCode" type="text" inputmode="numeric" placeholder="基金代码">
  <input id="holdAmount" type="text" inputmode="numeric" placeholder="持有金额">
  <button onclick="addFund()">添加</button>
</div>

<div id="fundList"></div>

<script>
let fundList = JSON.parse(localStorage.getItem('fundList_final') || '[]')
let isRefreshing = false

// 渲染列表 + 汇总
function render() {
  const listEl = document.getElementById('fundList')
  listEl.innerHTML = ''
  
  let totalMoney = 0
  let totalProfit = 0

  fundList.forEach((item, index) => {
    // 确保金额是数字类型，用于计算
    const money = parseFloat(item.money) || 0;
    totalMoney += money;
    
    const itemEl = document.createElement('div')
    itemEl.className = 'fund-item'
    itemEl.innerHTML = `
      <div class="item-header">
        <div>
          <span class="fund-code">${item.code}</span>
          <span class="fund-name" id="name-${index}">${item.name || '加载中...'}</span>
        </div>
        <div class="btn-group">
          <button class="edit-btn" onclick="editFund(${index})">
            <span style="display: block; line-height: 1.2;">编<br>辑</span>
          </button>
          <button class="delete-btn" onclick="deleteFund(${index})">
            <span style="display: block; line-height: 1.2;">删<br>除</span>
          </button>
        </div>
      </div>
      <div class="item-info" id="info-${index}">${item.info || '获取数据...'}</div>
    `
    listEl.appendChild(itemEl)
    
    if (item.info) {
      const profitMatch = item.info.match(/盈亏：<span class="[^"]+">([\d.-]+) 元/)
      if (profitMatch) {
        totalProfit += parseFloat(profitMatch[1]) || 0
      }
    }
  })

  document.getElementById('totalMoney').textContent = totalMoney.toFixed(2) + ' 元'
  const totalColor = totalProfit >= 0 ? 'red' : 'green'
  document.getElementById('totalProfit').className = `value ${totalColor}`
  document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' 元'

  refreshAllFunds()
}

// 编辑基金金额（使用自定义弹窗）
function editFund(index) {
  const item = fundList[index];
  const currentMoney = String(item.money || '0');

  // 创建弹窗
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal">
      <div class="modal-title">修改持有金额</div>
      <input type="number" class="modal-input" id="editInput" value="${currentMoney}">
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">取消</button>
        <button class="modal-btn modal-btn-confirm" onclick="confirmEdit(${index})">确定</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

// 关闭弹窗
function closeModal() {
  const overlay = document.querySelector('.modal-overlay');
  if (overlay) {
    document.body.removeChild(overlay);
  }
}

// 确认编辑
function confirmEdit(index) {
  const input = document.getElementById('editInput');
  const newMoney = input.value.trim();
  
  if (newMoney !== '' && !isNaN(newMoney)) {
    fundList[index].money = newMoney;
    localStorage.setItem('fundList_final', JSON.stringify(fundList));
    closeModal();
    render();
  } else {
    alert('请输入有效的金额');
  }
}

// 添加基金
function addFund() {
  const code = document.getElementById('fundCode').value.trim()
  const money = document.getElementById('holdAmount').value.trim()
  if (!code || !money) {
    alert('请输入基金代码和持有金额')
    return
  }
  fundList.push({ code, money: money, name: '', info: '' })
  localStorage.setItem('fundList_final', JSON.stringify(fundList))
  document.getElementById('fundCode').value = ''
  document.getElementById('holdAmount').value = ''
  render()
}

// 删除基金（自定义弹窗）
function deleteFund(index) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal">
      <div class="modal-title">确定要删除该基金吗？</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">取消</button>
        <button class="modal-btn modal-btn-confirm-delete" onclick="confirmDelete(${index})">确定删除</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

// 确认删除
function confirmDelete(index) {
  fundList.splice(index, 1);
  localStorage.setItem('fundList_final', JSON.stringify(fundList));
  closeModal();
  render();
}

// 获取单个基金数据（增强兼容版）
function fetchFundData(code, money, index) {
  window.jsonpgz = function(d) {
    try {
      const name = d.name || d.fundname || '未知基金';
      const gszzl = d.gszzl || d.growth || '0';
      const rate = parseFloat(gszzl) || 0;
      
      const profit = (money * rate / 100).toFixed(2);
      const colorClass = rate >= 0 ? 'red' : 'green';
      const info = `
        涨跌：<span class="${colorClass}">${rate.toFixed(2)}%</span><br>
        持有：${money} 元　盈亏：<span class="${colorClass}">${profit} 元</span>
      `;

      fundList[index].name = name;
      fundList[index].info = info;
      localStorage.setItem('fundList_final', JSON.stringify(fundList));

      const nameEl = document.getElementById(`name-${index}`);
      const infoEl = document.getElementById(`info-${index}`);
      if (nameEl) nameEl.textContent = name;
      if (infoEl) infoEl.innerHTML = info;
    } catch (e) {
      console.error('解析数据失败:', e);
      const infoEl = document.getElementById(`info-${index}`);
      if (infoEl) infoEl.textContent = '数据解析失败';
    } finally {
      delete window.jsonpgz;
    }
  }

  const script = document.createElement('script');
  script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
  script.onerror = function() {
    console.error('JSONP 请求失败');
    const infoEl = document.getElementById(`info-${index}`);
    if (infoEl) infoEl.textContent = '数据获取失败';
    delete window.jsonpgz;
  };
  document.body.appendChild(script);
}

// 刷新全部基金
async function refreshAllFunds() {
  if (isRefreshing) return
  isRefreshing = true
  
  for (let i = 0; i < fundList.length; i++) {
    const item = fundList[i]
    fetchFundData(item.code, item.money, i)
    await new Promise(resolve => setTimeout(resolve, 500))
  }
  
  isRefreshing = false
  render()
}

// 10秒自动刷新
setInterval(refreshAllFunds, 10000)

// 初始化
render()
</script>
</body>
</html>
