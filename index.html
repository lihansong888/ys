<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>基金实时估值-寒松个人版</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <style>
        /* ... 保持之前的 CSS 不变 ... */
        :root { --up: #ff4d4f; --down: #52c41a; --blue: #1890ff; --border: #e8e8e8; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 12px; margin: 0; }
        /* 增加一个加载占位符，防止白屏感 */
        #app:empty { height: 100vh; display: flex; align-items: center; justify-content: center; background: #f0f2f5; }
        #app:empty::after { content: "正在连接数据源..."; color: #999; font-size: 14px; }
        /* 之前的布局样式保持原样 */
        .summary-card { background: linear-gradient(135deg, #2f54eb, #1890ff); color: #fff; padding: 20px 15px; border-radius: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .control-panel { background: #fff; border-radius: 12px; padding: 10px; margin-top: 15px; border: 1px solid var(--border); }
        .input-row { display: flex; height: 44px; }
        .inputs-part { flex: 1; display: flex; border: 1px solid var(--border); border-radius: 8px 0 0 8px; overflow: hidden; }
        .inputs-part input, .inputs-part select { flex: 1; border: none; border-right: 1px solid var(--border); text-align: center; width: 30%; font-size: 13px; }
        .btn-part { width: 65px; background: var(--blue); border-radius: 0 8px 8px 0; display: flex; align-items: center; justify-content: center; }
        .add-btn-final { color: #fff; border: none; background: transparent; font-weight: bold; width: 100%; height: 100%; }
        .item-card { background: #fff; border-radius: 12px; padding: 15px; margin-top: 12px; border: 1px solid var(--border); }
        .up { color: var(--up); } .down { color: var(--down); }
    </style>
</head>
<body>

<div id="app">
    <div class="summary-card">
        <div style="text-align:center"><div>估算总市值</div><b>{{ totalAmount.toFixed(2) }}</b></div>
        <div style="text-align:center"><div>累计总投入</div><b>{{ totalCost.toFixed(2) }}</b></div>
        <div style="text-align:center"><div>持仓盈亏</div><b :class="totalProfit>=0?'up':'down'">{{ totalProfit>=0?'+':'' }}{{ totalProfit.toFixed(2) }}</b></div>
        <div style="text-align:center"><div>今日盈亏</div><b :class="totalDayProfit>=0?'up':'down'">{{ totalDayProfit>=0?'+':'' }}{{ totalDayProfit.toFixed(2) }}</b></div>
    </div>

    <div class="control-panel">
        <div class="input-row">
            <div class="inputs-part">
                <input v-model="form.code" placeholder="代码">
                <input v-model.number="form.money" type="number" placeholder="金额">
                <select v-model="form.type"><option value="基金">基金</option><option value="股票">股票</option></select>
            </div>
            <div class="btn-part"><button class="add-btn-final" @click="addItem">添加</button></div>
        </div>
    </div>

    <div v-for="item in fundList" :key="item.code" class="item-card">
        <div style="display:flex; justify-content:space-between">
            <b>{{item.name}}</b>
            <div>
                <button @click="openEdit(item)" style="border:none; background:var(--blue); color:#fff; border-radius:4px; padding:2px 8px; margin-right:5px">编辑</button>
                <button @click="confirmDelete(item)" style="border:none; background:#ff4d4f; color:#fff; border-radius:4px; padding:2px 8px">删除</button>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:14px">
            <span>涨跌：<span :class="item.changeRate>=0?'up':'down'">{{item.changeRate>=0?'+':''}}{{item.changeRate}}%</span></span>
            <span>盈亏：<span :class="(item.price*item.myShare-item.cost)>=0?'up':'down'">{{(item.price*item.myShare-item.cost).toFixed(2)}}</span></span>
        </div>
    </div>
</div>

<script>
// 如果 Vue 加载失败，给用户提示，而不是白屏
if (typeof Vue === 'undefined') {
    document.getElementById('app').innerHTML = "<div style='padding:20px;text-align:center;color:red'>依赖加载失败，请检查网络或重新打包 APK。</div>";
} else {
    new Vue({
        el: '#app',
        data: {
            form: { code: '', money: '', type: '基金' },
            assets: JSON.parse(localStorage.getItem('assets_final_v2') || '{}'),
            fundList: []
        },
        computed: {
            totalAmount() { return this.fundList.reduce((s, i) => s + (i.price * i.myShare), 0); },
            totalCost() { return this.fundList.reduce((s, i) => s + i.cost, 0); },
            totalProfit() { return this.totalAmount - this.totalCost; },
            totalDayProfit() { return this.fundList.reduce((s, i) => s + (i.dayProfit || 0), 0); }
        },
        mounted() { this.refreshAll(); setInterval(this.refreshAll, 10000); },
        methods: {
            async refreshAll() {
                const list = [];
                for (const code in this.assets) {
                    const info = this.assets[code];
                    const live = await this.fetchData(code, info.type);
                    if (live) {
                        const sh = info.money / live.prev;
                        list.push({ ...live, code, cost: info.money, myShare: sh, dayProfit: (live.price - live.prev) * sh });
                    }
                }
                this.fundList = list;
            },
            async fetchData(code, type) {
                try {
                    if (type === '基金') {
                        return new Promise(res => {
                            const callbackName = 'jsonp_' + Math.random().toString(36).substr(2);
                            window[callbackName] = (d) => { res({ name: d.name, price: parseFloat(d.gsz), changeRate: parseFloat(d.gszzl), prev: parseFloat(d.dwjz) }); };
                            const s = document.createElement('script');
                            s.src = `https://fundgz.1234567.com.cn/js/${code}.js?callback=${callbackName}`;
                            document.body.appendChild(s);
                            setTimeout(() => res(null), 5000);
                        });
                    } else {
                        const r = await fetch(`https://hq.sinajs.cn/list=${code.toLowerCase()}`).catch(()=>null);
                        if(!r) return null;
                        const t = await r.text();
                        const d = t.split('"')[1].split(',');
                        return { name: d[0], price: parseFloat(d[3]), changeRate: parseFloat(((d[3]-d[2])/d[2]*100).toFixed(2)), prev: parseFloat(d[2]) };
                    }
                } catch (e) { return null; }
            },
            addItem() {
                if(!this.form.code || !this.form.money) return;
                this.$set(this.assets, this.form.code, { money: parseFloat(this.form.money), type: this.form.type });
                localStorage.setItem('assets_final_v2', JSON.stringify(this.assets));
                this.refreshAll();
            }
        }
    });
}
</script>
</body>
</html>
