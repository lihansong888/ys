<script>
    let assets = JSON.parse(localStorage.getItem('assets_v3') || '{}');
    let fundList = [];

    function setTip(txt) {
        const el = document.getElementById('msgTip');
        if(el) el.innerText = "状态: " + txt;
    }

    async function refreshAll() {
        const keys = Object.keys(assets);
        if(keys.length === 0) {
            setTip("暂无数据，请添加代码");
            render(0, 0, 0);
            return;
        }

        setTip("同步数据中...");
        fundList = [];
        let tAmount = 0, tCost = 0, tDayProfit = 0;

        // 核心改动：并发抓取，防止一个卡住全部卡死
        const promises = keys.map(async (code) => {
            const info = assets[code];
            const live = await fetchData(code, info.type);
            if (live) {
                const sh = info.money / live.prev;
                const currentVal = live.price * sh;
                tAmount += currentVal;
                tCost += info.money;
                tDayProfit += (live.price - live.prev) * sh;
                fundList.push({ ...live, code, profit: currentVal - info.money, cost: info.money });
            }
        });

        await Promise.all(promises);
        render(tAmount, tCost, tDayProfit);
        setTip("更新成功 " + new Date().toLocaleTimeString());
    }

    async function fetchData(code, type) {
        return new Promise(res => {
            const timeout = setTimeout(() => res(null), 4000); // 4秒超时
            try {
                if (type === '基金') {
                    const cb = 'cb' + Math.floor(Math.random()*100000);
                    window[cb] = (d) => { 
                        clearTimeout(timeout);
                        res({name:d.name, price:parseFloat(d.gsz), prev:parseFloat(d.dwjz), changeRate:d.gszzl}); 
                        delete window[cb];
                    };
                    const s = document.createElement('script');
                    // 关键：去掉协议头，让它跟随系统环境
                    s.src = `//fundgz.1234567.com.cn/js/${code}.js?callback=${cb}&rt=${Date.now()}`;
                    document.head.appendChild(s);
                } else {
                    fetch(`//hq.sinajs.cn/list=${code.toLowerCase()}`)
                        .then(r => r.text())
                        .then(t => {
                            clearTimeout(timeout);
                            const d = t.split('"')[1].split(',');
                            const p = parseFloat(d[3]), v = parseFloat(d[2]);
                            res({ name:d[0], price:p, prev:v, changeRate:((p-v)/v*100).toFixed(2) });
                        }).catch(() => res(null));
                }
            } catch(e) { res(null); }
        });
    }

    function render(tAmount, tCost, tDayProfit) {
        document.getElementById('totalAmount').innerText = tAmount.toFixed(2);
        document.getElementById('totalCost').innerText = tCost.toFixed(2);
        const tp = document.getElementById('totalProfit');
        const profit = tAmount - tCost;
        tp.innerText = (profit >= 0 ? '+' : '') + profit.toFixed(2);
        tp.className = 'sum-val ' + (profit >= 0 ? 'up' : 'down');
        const tdp = document.getElementById('totalDayProfit');
        tdp.innerText = (tDayProfit >= 0 ? '+' : '') + tDayProfit.toFixed(2);
        tdp.className = 'sum-val ' + (tDayProfit >= 0 ? 'up' : 'down');

        let html = '';
        fundList.forEach(item => {
            html += `
                <div class="item-card">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <b>${item.name}</b>
                        <button onclick="deleteItem('${item.code}')" style="border:none; background:#ff4d4f; color:#fff; border-radius:4px; padding:4px 10px; font-size:12px">删除</button>
                    </div>
                    <div class="card-row">
                        <span>涨跌：<span class="${parseFloat(item.changeRate)>=0?'up':'down'}">${parseFloat(item.changeRate)>=0?'+':''}${item.changeRate}%</span></span>
                        <span>盈亏：<span class="${item.profit>=0?'up':'down'}">${item.profit>=0?'+':''}${item.profit.toFixed(2)}</span></span>
                    </div>
                </div>`;
        });
        document.getElementById('listContainer').innerHTML = html;
    }

    function handleAddItem() {
        // 使用更稳妥的方式获取输入值
        const c = document.querySelector('#inCode').value.replace(/\s+/g,"");
        const m = document.querySelector('#inMoney').value;
        const t = document.querySelector('#inType').value;

        if(!c || !m) {
            setTip("请填入代码和金额");
            return;
        }

        setTip("正在添加并联网查询...");
        assets[c] = { money: parseFloat(m), type: t };
        localStorage.setItem('assets_v3', JSON.stringify(assets));
        
        document.querySelector('#inCode').value =
