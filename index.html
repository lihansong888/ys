<script>
    // 1. 初始化数据，确保从本地存储读取
    let assets = JSON.parse(localStorage.getItem('assets_v3') || '{}');
    let fundList = [];

    // 2. 核心刷新逻辑
    async function refreshAll() {
        console.log("正在刷新数据...");
        fundList = [];
        let tAmount = 0, tCost = 0, tDayProfit = 0;

        for (const code in assets) {
            const info = assets[code];
            const live = await fetchData(code, info.type);
            if (live) {
                const sh = info.money / live.prev;
                const currentVal = live.price * sh;
                const profit = currentVal - info.money;
                const dayProfit = (live.price - live.prev) * sh;
                
                tAmount += currentVal;
                tCost += info.money;
                tDayProfit += dayProfit;

                fundList.push({ ...live, code, profit, currentVal, cost: info.money });
            }
        }
        render(tAmount, tCost, tDayProfit);
    }

    // 3. 数据抓取逻辑
    async function fetchData(code, type) {
        try {
            if (type === '基金') {
                return new Promise(res => {
                    const cb = 'cb' + Math.random().toString(36).substr(2);
                    window[cb] = (d) => { 
                        res({name:d.name, price:parseFloat(d.gsz), prev:parseFloat(d.dwjz), changeRate:d.gszzl}); 
                        delete window[cb];
                    };
                    const s = document.createElement('script');
                    s.src = `https://fundgz.1234567.com.cn/js/${code}.js?callback=${cb}`;
                    document.head.appendChild(s);
                    setTimeout(() => { s.remove(); res(null); }, 5000);
                });
            } else {
                const r = await fetch(`https://hq.sinajs.cn/list=${code.toLowerCase()}`);
                const t = await r.text();
                const d = t.split('"')[1].split(',');
                if(d.length < 4) return null;
                const p = parseFloat(d[3]), v = parseFloat(d[2]);
                return { name:d[0], price:p, prev:v, changeRate:((p-v)/v*100).toFixed(2) };
            }
        } catch(e) { return null; }
    }

    // 4. 渲染页面
    function render(tAmount, tCost, tDayProfit) {
        document.getElementById('totalAmount').innerText = tAmount.toFixed(2);
        document.getElementById('totalCost').innerText = tCost.toFixed(2);
        
        const tp = document.getElementById('totalProfit');
        const profit = tAmount - tCost;
        tp.innerText = (profit >= 0 ? '+' : '') + profit.toFixed(2);
        tp.className = 'sum-val ' + (profit >= 0 ? 'up' : 'down');

        const tdp = document.getElementById('totalDayProfit');
        tdp.innerText = (tDayProfit >= 0 ? '+' : '') + tDayProfit.toFixed(2);
        tdp.className = 'sum-val ' + (tDayProfit >= 0 ? 'up' : 'down');

        let html = '';
        fundList.forEach(item => {
            html += `
                <div class="item-card">
                    <div style="display:flex; justify-content:space-between">
                        <b class="item-name">${item.name}</b>
                        <button onclick="deleteItem('${item.code}')" style="border:none; background:#ff4d4f; color:#fff; border-radius:4px; padding:4px 10px">删除</button>
                    </div>
                    <div class="card-row">
                        <span>涨跌：<span class="${item.changeRate>=0?'up':'down'}">${item.changeRate >= 0 ? '+' : ''}${item.changeRate}%</span></span>
                        <span>盈亏：<span class="${item.profit>=0?'up':'down'}">${item.profit >= 0 ? '+' : ''}${item.profit.toFixed(2)}</span></span>
                    </div>
                </div>`;
        });
        document.getElementById('listContainer').innerHTML = html;
    }

    // 5. 【修正重点】添加资产逻辑
    function addItem() {
        const codeInput = document.getElementById('inCode');
        const moneyInput = document.getElementById('inMoney');
        const typeInput = document.getElementById('inType');

        const code = codeInput.value.trim();
        const money = parseFloat(moneyInput.value);
        const type = typeInput.value;

        if(!code || isNaN(money)) {
            alert("请输入正确的代码和金额");
            return;
        }

        // 保存到内存和本地存储
        assets[code] = { money: money, type: type };
        localStorage.setItem('assets_v3', JSON.stringify(assets));
        
        // 立即清空并刷新
        codeInput.value = '';
        moneyInput.value = '';
        refreshAll();
    }

    // 6. 删除逻辑
    function deleteItem(code) {
        if(confirm("确定删除吗？")) {
            delete assets[code];
            localStorage.setItem('assets_v3', JSON.stringify(assets));
            refreshAll();
        }
    }

    // 7. 初始化执行
    window.onload = () => {
        refreshAll();
        setInterval(refreshAll, 10000);
    };
</script>
